<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/utils/image.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="https://github.com/proteus-h2020/proteic.git" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">utils</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-svgAsDataUri">svgAsDataUri</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/utils/image.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">
const doctype = &apos;&lt;?xml version=&quot;1.0&quot; standalone=&quot;no&quot;?&gt;&lt;!DOCTYPE svg PUBLIC &quot;-//W3C//DTD SVG 1.1//EN&quot; &quot;http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd&quot;&gt;&apos;;

function isExternal(url) {
  return url &amp;&amp; url.lastIndexOf(&apos;http&apos;, 0) === 0 &amp;&amp; url.lastIndexOf(window.location.host) === -1;
}

function inlineImages(el, callback) {
  let images = el.querySelectorAll(&apos;image&apos;);
  let left = images.length;
  if (left === 0) {
    callback();
  }
  for (var i = 0; i &lt; images.length; i++) {
    (function (image) {
      var href = image.getAttribute(&apos;xlink:href&apos;);
      if (href) {
        if (isExternal(href.value)) {
          window.console.warn(&apos;Cannot render embedded images linking to external hosts: &apos; + href.value);
          return;
        }
      }
      let canvas = window.document.createElement(&apos;canvas&apos;);
      let ctx = canvas.getContext(&apos;2d&apos;);
      let img = new window.Image();
      href = href || image.getAttribute(&apos;href&apos;);
      img.src = href;
      img.onload = function () {
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);
        image.setAttribute(&apos;xlink:href&apos;, canvas.toDataURL(&apos;image/png&apos;));
        left--;
        if (left === 0) {
          callback();
        }
      };
      img.onerror = function () {
        window.console.error(&apos;Could not load &apos; + href);
        left--;
        if (left === 0) {
          callback();
        }
      };
    })(images[i]);
  }
}

function styles(el, selectorRemap) {
  let css = &apos;&apos;;
  let sheets = document.styleSheets;
  for (var i = 0; i &lt; sheets.length; i++) {
    if (isExternal(sheets[i].href)) {
      window.console.warn(&apos;Cannot include styles from other hosts: &apos; + sheets[i].href);
      continue;
    }
    let rules = sheets[i].cssRules;
    if (rules !== null) {
      for (var j = 0; j &lt; rules.length; j++) {
        let rule = rules[j];
        if (typeof (rule.style) !== &apos;undefined&apos;) {
          let match = null;
          try {
            match = el.querySelector(rule.selectorText);
          } catch (err) {
            window.console.warn(&apos;Invalid CSS selector &quot;&apos; + rule.selectorText + &apos;&quot;&apos;, err);
          }
          if (match) {
            var selector = selectorRemap ? selectorRemap(rule.selectorText) : rule.selectorText;
            css += selector + &apos; { &apos; + rule.style.cssText + &apos; }\n&apos;;
          } else if (rule.cssText.match(/^@font-face/)) {
            css += rule.cssText + &apos;\n&apos;;
          }
        }
      }
    }
  }
  return css;
}

export function svgAsDataUri(el, options, cb) {
  options = options || {};
  options.scale = options.scale || 1;
  var xmlns = &apos;http://www.w3.org/2000/xmlns/&apos;;

  inlineImages(el, function () {
    var outer = document.createElement(&apos;div&apos;);
    var clone = el.cloneNode(true);
    var width, height;
    if (el.tagName === &apos;svg&apos;) {
      width = parseInt(clone.getAttribute(&apos;width&apos;) || clone.style.width || getComputedStyle(el).getPropertyValue(&apos;width&apos;));
      height = parseInt(clone.getAttribute(&apos;height&apos;) || clone.style.height || getComputedStyle(el).getPropertyValue(&apos;height&apos;));
    } else {
      let box = el.getBBox();
      width = box.x + box.width;
      height = box.y + box.height;
      clone.setAttribute(&apos;transform&apos;, clone.getAttribute(&apos;transform&apos;).replace(/translate\(.*?\)/, &apos;&apos;));

      let svg = document.createElementNS(&apos;http://www.w3.org/2000/svg&apos;, &apos;svg&apos;);
      svg.appendChild(clone);
      clone = svg;
    }

    clone.setAttribute(&apos;version&apos;, &apos;1.1&apos;);
    clone.setAttributeNS(xmlns, &apos;xmlns&apos;, &apos;http://www.w3.org/2000/svg&apos;);
    clone.setAttributeNS(xmlns, &apos;xmlns:xlink&apos;, &apos;http://www.w3.org/1999/xlink&apos;);
    clone.setAttribute(&apos;width&apos;, width * options.scale);
    clone.setAttribute(&apos;height&apos;, height * options.scale);
    clone.setAttribute(&apos;viewBox&apos;, &apos;0 0 &apos; + width + &apos; &apos; + height);
    outer.appendChild(clone);

    let css = styles(el, options.selectorRemap);
    let s = document.createElement(&apos;style&apos;);
    s.setAttribute(&apos;type&apos;, &apos;text/css&apos;);
    s.innerHTML = &apos;&lt;![CDATA[\n&apos; + css + &apos;\n]]&gt;&apos;;
    let defs = document.createElement(&apos;defs&apos;);
    defs.appendChild(s);
    clone.insertBefore(defs, clone.firstChild);

    let svg = doctype + outer.innerHTML;
    let uri = &apos;data:image/svg+xml;base64,&apos; + window.btoa(window.unescape(encodeURIComponent(svg)));
    if (cb) {
      cb(uri);
    }
  });
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.5.2)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
